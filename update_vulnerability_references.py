import os
import re
from tqdm import tqdm

import requests
from lxml.html import fromstring

DIR = "vulnerabilities"
REGEX = re.compile(r"\[JFrog Blogpost\]\((.+?)\)")

for fname in tqdm(os.listdir(DIR)):
    print(fname)
    fpath = os.path.join(DIR, fname)
    with open(fpath) as f:
        data = f.read()
    url = REGEX.findall(data)
    if not url:
        continue
    url = url[0]
    print(url)

    # Fetch title
    r = requests.get(url)
    tree = fromstring(r.content)
    title = tree.findtext('.//title')
    if "|" in title:
        title = title[:title.rfind("|")]
    title.rstrip()
    print(title)

    # Replace "[JFrog Blogpost]" with the title
    data = data[:data.find("[JFrog Blogpost]")]
    data += f"[(JFrog) {title}]"
    data += f"({url})"

    with open(fpath, "w") as f:
        f.write(data)