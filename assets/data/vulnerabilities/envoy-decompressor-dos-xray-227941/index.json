{"hash":"bd9be3e9777a4849c71d4d3db57c954b6b615b5c","data":{"post":{"title":"Envoy proxy decompressor memory exhaustion DoS","path":"/vulnerabilities/envoy-decompressor-dos-xray-227941/","content":"<h2 id=\"summary\"><a href=\"#summary\" aria-hidden=\"true\" tabindex=\"-1\">Summary</a></h2>\n<p>A memory exhaustion issue in Envoy Proxy's decompressors can allow a remote attacker to perform denial of service</p>\n<h2 id=\"component\"><a href=\"#component\" aria-hidden=\"true\" tabindex=\"-1\">Component</a></h2>\n<p><a href=\"https://www.envoyproxy.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Envoy Proxy</a></p>\n<h2 id=\"affected-versions\"><a href=\"#affected-versions\" aria-hidden=\"true\" tabindex=\"-1\">Affected versions</a></h2>\n<p>Envoy Proxy (,1.19.5)|(,1.20.4)|(,1.21.3)|(,1.22.1), fixed in [1.19.5]|[1.20.4]|[1.21.3]|[1.22.1]</p>\n<h2 id=\"description\"><a href=\"#description\" aria-hidden=\"true\" tabindex=\"-1\">Description</a></h2>\n<p>The <a href=\"https://www.envoyproxy.io/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Envoy proxy</a> has the possibility to decompress Gzip and Brotli data. These features can be enabled via configuration, by adding the relevant filters. For example, to enable Brotli decompression, the following filter could be added under <code>http_filters</code> in the <code>envoy.yaml</code> configuration file:</p>\n<pre><code class=\"language-yaml\">name: decompressor\ntyped_config:\n    \"@type\": type.googleapis.com/envoy.extensions.filters.http.decompressor.v3.Decompressor\n    decompressor_library:\n        name: basic\n            typed_config:\n                \"@type\": type.googleapis.com/envoy.extensions.compression.brotli.decompressor.v3.Brotli\n</code></pre>\n<p>The code that is in charge of decompressing the user supplied data does not implement a size limit for the output buffer, allowing the buffering of virtually unlimited amounts of data by accumulating all the extracted data into one large buffer before sending it upstream. An attacker can send a simple Brotli <a href=\"https://en.wikipedia.org/wiki/Zip_bomb\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Zip Bomb</a> (a small zip file that decompresses to a very large file) that can cause severe performance issues or crash the Envoy process due to memory exhaustion.</p>\n<p>Note that while the vulnerability's root cause exists in both the Gzip and Brotli decompressors, a crashing payload was only demonstrated on the Brotli decompressor (since no Gzip payload was able to exhaust enough memory to cause a crash)</p>\n<h2 id=\"poc\"><a href=\"#poc\" aria-hidden=\"true\" tabindex=\"-1\">PoC</a></h2>\n<p><code>curl -v http://10.0.0.1:10000 -H \"Content-Encoding: br\" -H \"Expect:\" --data-binary @10GB.br</code></p>\n<p>Where <code>10GB.br</code> is a Brotli-compressed file that decompresses to 10GB</p>\n<h2 id=\"vulnerability-mitigations\"><a href=\"#vulnerability-mitigations\" aria-hidden=\"true\" tabindex=\"-1\">Vulnerability Mitigations</a></h2>\n<p>If upgrading is not possible, make sure that your configuration does not allow Brotli decompression. The Brotli decompressor (<code>type.googleapis.com/envoy.extensions.compression.brotli.decompressor.v3.Brotli</code>) can either be completely removed, or replaced with the Gzip decompressor (<code>type.googleapis.com/envoy.extensions.compression.gzip.decompressor.v3.Gzip</code>)</p>\n<h2 id=\"references\"><a href=\"#references\" aria-hidden=\"true\" tabindex=\"-1\">References</a></h2>\n<p><a href=\"https://jfrog.com/blog/denial-of-service-vulnerability-in-envoy-proxy-cve-2022-29225/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">(JFrog) Denial of Service Vulnerability in Envoy Proxy â€“ CVE-2022-29225</a></p>\n<p><a href=\"https://nvd.nist.gov/vuln/detail/CVE-2022-29225\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">NVD</a></p>\n","description":"CVE-2022-29225 High severity. Memory exhaustion in Envoy proxy decompressors leads to denial of service","date_published":"2022-06-09","xray_id":"XRAY-227941","vul_id":"CVE-2022-29225","severity":"high","discovered_by":"Ori Hollander","last_updated":"2022-06-09","cvss":7.5}},"context":{}}