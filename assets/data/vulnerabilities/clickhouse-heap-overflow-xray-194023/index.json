{"hash":"395440ef224a898db42a76f9a89f4f80db8aa4f5","data":{"post":{"title":"ClickHouse heap overflow","path":"/vulnerabilities/clickhouse-heap-overflow-xray-194023/","content":"<h2 id=\"summary\"><a href=\"#summary\" aria-hidden=\"true\" tabindex=\"-1\">Summary</a></h2>\n<p>Heap overflow in ClickHouse can allow an authenticated network attacker to perform remote code execution</p>\n<h2 id=\"component\"><a href=\"#component\" aria-hidden=\"true\" tabindex=\"-1\">Component</a></h2>\n<p><a href=\"https://clickhouse.com/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Clickhouse</a></p>\n<h2 id=\"affected-versions\"><a href=\"#affected-versions\" aria-hidden=\"true\" tabindex=\"-1\">Affected versions</a></h2>\n<p>(, v21.9.5.16-stable], fixed in v21.10.2.15-stable</p>\n<h2 id=\"description\"><a href=\"#description\" aria-hidden=\"true\" tabindex=\"-1\">Description</a></h2>\n<p>There is no verification that the copy operations in the <code class=\"language-inline-text\">LZ4::decompressImpl</code> loop and especially the arbitrary copy operation <code class=\"language-inline-text\">wildCopy&lt;copy_amount&gt;(op, ip, copy_end)</code>, don’t exceed the destination buffer’s limits. Note that the lengths of the overflow, as well as source’s allocation size and the overflowing byte contents are fully controlled by the user. Also note that specifically this size check happens after the copy operation while the other copy operations aren’t covered at all.</p>\n<p>A low-privileged authenticated network attacker can trigger this issue by sending crafted LZ4 data in a decompression request.</p>\n<p>This issue is very similar to CVE-2021-37138, but the vulnerable copy operation is in a different <code class=\"language-inline-text\">wildCopy</code> call.</p>\n<h2 id=\"poc\"><a href=\"#poc\" aria-hidden=\"true\" tabindex=\"-1\">PoC</a></h2>\n<div class=\"gridsome-highlight\" data-language=\"bash\"><pre style=\"counter-reset: linenumber NaN\" class=\"language-bash line-numbers\"><code class=\"language-bash\"><span class=\"token function\">cat</span> query.bin <span class=\"token operator\">|</span> <span class=\"token function\">curl</span> -sS --data-binary @- <span class=\"token string\">'http://serverIP:8123/?user=guest1&amp;password=1234&amp;decompress=1'</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span></span></pre></div>\n<p>Get a crashing <code class=\"language-inline-text\">query.bin</code> <a href=\"https://jfrog.com/blog/TBDTBD\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">here</a></p>\n<h2 id=\"vulnerability-mitigations\"><a href=\"#vulnerability-mitigations\" aria-hidden=\"true\" tabindex=\"-1\">Vulnerability mitigations</a></h2>\n<p>If upgrading is not possible, add firewall rules in the server that will restrict the access to the web port (8123) and the TCP server’s port (9000) for only specific clients.</p>\n<h2 id=\"references\"><a href=\"#references\" aria-hidden=\"true\" tabindex=\"-1\">References</a></h2>\n<p><a href=\"https://jfrog.com/blog/TBDTBD\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">JFrog Blogpost</a></p>\n","description":"","date_published":"2021-10-09","xray_id":"XRAY-194023","vul_id":"CVE-2021-37139","severity":"high","discovered_by":"Uriya Yavnieli","last_updated":"2021-10-09","cvss":8.8}},"context":{}}