{"hash":"4dbbcc43a7f650b7014a6db610108566e3bb5f5a","data":{"modelThreatsPost":{"title":"TFLOW-LAMBDA","path":"/model-threats/tflow-lambda/","content":"<h2 id=\"overview\"><a href=\"#overview\" aria-hidden=\"true\" tabindex=\"-1\">Overview</a></h2>\n<p>A TensorFlow SavedModel may contain a \"Lambda\" layer, which contains embedded Python code in binary format. <strong>This code may contain malicious instructions</strong> which will be executed when the model is loaded.</p>\n<p>The TensorFlow SavedModel format is a legacy format used by TensorFlow to store ML models. A SavedModel is a directory that contains a complete TensorFlow program, including weights and computation. It does not require the original model building code to run.</p>\n<p><img src=\"/img/savedmodel_format.png\"></p>\n<p>The SavedModel directory contains the Keras model metadata in a file called <code>keras_metadata.pb</code>, this is a <a href=\"https://protobuf.dev/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">ProtoBuf</a>-serialized binary which contains Keras Layers denoted as <code>_tf_keras_layer</code> nodes. These layers contain a standard Keras Model Configuration in JSON format.</p>\n<p>The Model Configuration specifies all the layers of the model, and may specify a <strong>Lambda</strong> layer.</p>\n<p>The Lambda layer specifies custom operations defined by the model author, which are defined simply by a raw Python code object (Python Bytecode).</p>\n<p><img src=\"/img/hdf5_lambda.png\"></p>\n<p><strong>Since arbitrary Python Bytecode can contain any operation, including malicious operations</strong>, loading an untrusted TensorFlow SavedModel is considered to be dangerous.</p>\n<h2 id=\"time-of-infection\"><a href=\"#time-of-infection\" aria-hidden=\"true\" tabindex=\"-1\">Time of Infection</a></h2>\n<p><strong>[v] Model Load</strong></p>\n<p>[] Model Query</p>\n<p>[] Other</p>\n<h2 id=\"evidence-extraction-and-false-positive-elimination\"><a href=\"#evidence-extraction-and-false-positive-elimination\" aria-hidden=\"true\" tabindex=\"-1\">Evidence Extraction and False Positive Elimination</a></h2>\n<p>To safely determine if the suspected TensorFlow SavedModel contains malicious code -</p>\n<ol>\n<li>Identify the <code>keras_metadata.pb</code> file in your SavedModel directory</li>\n<li>\n<p>Extract any raw Python bytecode in <code>Lambda</code> layers present in <code>_tf_keras_layer</code> nodes, this can be done with the following Python code snippet -</p>\n<pre><code class=\"language-python\">import json\nfrom tensorflow.python.keras.protobuf.saved_metadata_pb2 import SavedMetadata\n\nSUSPECTED_MODEL_PATH = \"/path/to/savedmodel/keras_metadata.pb\"\n\nsaved_metadata = SavedMetadata()\nwith open(SUSPECTED_MODEL_PATH, \"rb\") as f:\n    saved_metadata.ParseFromString(f.read())\n\nlambda_code = [layer[\"config\"][\"function\"][\"items\"][0]\n    for layer in [json.loads(node.metadata)\n        for node in saved_metadata.nodes\n        if node.identifier == \"_tf_keras_layer\"]\n    if layer[\"class_name\"] == \"Lambda\"]\n\nprint(lambda_code)\n</code></pre>\n</li>\n<li>Decompile the raw Python bytecodes, ex. using <a href=\"https://github.com/zrax/pycdc\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">pycdc</a></li>\n<li>Examine the decompiled Python code to determine if it contains any malicious instructions</li>\n</ol>\n<p>JFrog conducts extraction, decompilation and detailed analysis on each TensorFlow SavedModel in order to determine whether any malicious code is present.</p>\n<h2 id=\"additional-information\"><a href=\"#additional-information\" aria-hidden=\"true\" tabindex=\"-1\">Additional Information</a></h2>\n<ul>\n<li><a href=\"https://github.com/Azure/counterfit/wiki/Abusing-ML-model-file-formats-to-create-malware-on-AI-systems:-A-proof-of-concept\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://github.com/Azure/counterfit/wiki/Abusing-ML-model-file-formats-to-create-malware-on-AI-systems:-A-proof-of-concept</a></li>\n</ul>\n","description":"TensorFlow SavedModel with Lambda Layers containing malicious code"}},"context":{}}