{"hash":"3a704e29ab526df657aab877b9cccfae4452db5b","data":{"modelThreatsPost":{"title":"KERAS-CUSTOM","path":"/model-threats/keras-custom/","content":"<h2 id=\"overview\"><a href=\"#overview\" aria-hidden=\"true\" tabindex=\"-1\">Overview</a></h2>\n<p>A Keras model may contain custom \"Lambda\" layers, which do not contain embedded Python code but rather trigger function calls to standard library functions with arbitrary arguments. <strong>These function calls may trigger malicious payloads</strong> which will be executed when the model is loaded.</p>\n<p>The Keras v3 format is the latest format used by TensorFlow and Keras to store ML models.</p>\n<p><img src=\"/img/kerasv3_format.png\"></p>\n<p>Internally, this format is a ZIP archive which contains a JSON file called <code>config.json</code> which specifies the configuration of the ML Model.</p>\n<p>The Model Configuration specifies all the layers of the model, and may specify a <strong>Lambda</strong> layer.</p>\n<p>A Lambda layer can contain raw Python Bytecode (the code is embedded into the Keras model), but can alternatively contain references to standard library functions, without the need to embed Python Bytecode into the model.</p>\n<p>For example, a Lambda layer can achieve arbitrary shell command execution when the model is loaded, by calling the <code>os.system</code> standard library function -</p>\n<pre><code class=\"language-json\">\"config\": {\n    \"layers\": [{\n            \"module\": \"keras.layers\",\n            \"class_name\": \"Lambda\",\n            \"config\": {\n                \"arguments\": {                    \n                    \"key\": {\n                        \"class_name\": \"function\",\n                        \"config\": \"system\",\n                        \"module\": \"os\"\n                    },\n                    \"iterable\": [\"ls -l\"],\n                },\n...      \n</code></pre>\n<p><strong>Since execution of arbitrary shell commands can include malicious operations</strong>, loading an untrusted Keras v3 Model is considered to be dangerous.</p>\n<p>This code execution technique is extremely effective and dangerous, since malicious models that only \"reference\" standard library functions (and do not embed Python bytecode) <strong>are still allowed to be loaded even with Keras' <a href=\"https://www.tensorflow.org/api_docs/python/tf/keras/models/load_model\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">safe_mode</a> protection enabled</strong> -</p>\n<pre><code class=\"language-python\">tf.keras.models.load_model(\"malicious_model.keras\", safe_mode=True) # Will still load!\n</code></pre>\n<h2 id=\"time-of-infection\"><a href=\"#time-of-infection\" aria-hidden=\"true\" tabindex=\"-1\">Time of Infection</a></h2>\n<p><strong>[v] Model Load</strong></p>\n<p>[] Model Query</p>\n<p>[] Other</p>\n<h2 id=\"evidence-extraction-and-false-positive-elimination\"><a href=\"#evidence-extraction-and-false-positive-elimination\" aria-hidden=\"true\" tabindex=\"-1\">Evidence Extraction and False Positive Elimination</a></h2>\n<p>To safely determine if the suspected Keras v3 model contains malicious code -</p>\n<ol>\n<li>Extract and parse the <code>config.json</code> file from the Keras v3 model zip archive, to identify <code>Lambda</code> layers</li>\n<li>For each layer with <code>class_name == \"function\"</code> , inspect the <code>module</code> and <code>config</code> (function) parameters</li>\n<li>Examine whether the parameters include names of well known dangerous modules or functions, such as <code>system</code>, <code>subprocess</code>, <code>eval</code>, <code>exec</code> etc.</li>\n</ol>\n<p>JFrog conducts extraction and detailed analysis on each Keras v3 model in order to determine whether any malicious code is present.</p>\n<h2 id=\"additional-information\"><a href=\"#additional-information\" aria-hidden=\"true\" tabindex=\"-1\">Additional Information</a></h2>\n","description":"Keras model with Custom Layers calling malicious functions"}},"context":{}}